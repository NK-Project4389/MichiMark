# MichiMark 設計原則（Design Principles）

## 0. この文書の位置づけ

本書は MichiMark における設計判断の拠り所（憲法）である。
個別仕様、UI、Action フローが変更されても、本書の原則は維持される。

- 実装は本書に従う
- 判断に迷った場合は本書に立ち返る
- 本書を変更する場合は、その理由を明示する

---

## 1. 全体思想

### 1.1 MichiMark が扱う本質

MichiMark は以下の概念を扱うアプリケーションである。

- イベント（ある期間・文脈での行動）
- 移動・地点・区間（Mark / Link）
- 人・支払い・役割（Member / Trans）
- 記録と振り返り

これらは UI ではなく Domain に属する概念である。

---

## 2. レイヤードアーキテクチャの原則

### 2.1 レイヤー構成

MichiMark は以下の責務分離を前提とする。

```text
View
 └ Projection
    └ Draft
       └ Adapter
          └ Domain
             └ Repository
```

### 2.2 各レイヤーの責務

#### Domain
- 業務概念の正規表現
- 永続化される実体
- UI や状態遷移を一切知らない

#### Adapter
- Draft から Domain への変換
- バリデーション
- 生成ルールの集約

#### Draft
- 未確定、編集中の状態を表す
- 入力途中や不完全な状態を許容する
- 永続化しない

#### Projection
- View 都合の整形データ
- Domain や Draft を加工する
- 状態を保持しない

#### View
- 表示と入力のみを担当する
- ビジネスルールを持たない

---

## 3. Root の責務原則

### 3.1 Root はナビゲーションのみを責務とする

RootReducer の責務は以下に限定される。

- 画面遷移の管理
- Navigation Stack の制御
- Feature 間遷移のハブ

Root は以下を行わない。

- 業務ロジックの実装
- Draft の編集
- Domain の直接操作
- バリデーション処理

---

### 3.2 Root は Draft のライフサイクルを管理しうる

以下は例外として許容する。

- Draft の生成
- Draft の破棄
- Draft の引き回し

これは業務ロジックではなく状態管理であり、Root の責務と矛盾しない。

---

## 4. Feature の責務原則

### 4.1 Feature は局所的な振る舞いを持つ

各 Feature（EventDetail、MichiInfo、MarkDetail 等）は以下を責務とする。

- 自身の View 状態管理
- 自身の Draft 操作
- 自身の Projection 管理

---

## 5. ナビゲーション設計の原則

### 5.1 ナビゲーションは構造を表す

- 画面遷移は状態構造である
- if / else ではなく State Tree で表現する
- 遷移可能性は Action ではなく State の存在で示す

---

### 5.2 Path は履歴ではなく現在の構造である

- StackState は画面履歴ではない
- 現在成立している画面構造を表す

---

## 6. Delegate / Selection 設計原則

### 6.1 Delegate は意図を運ぶ

Delegate は以下を必ず含む。

- 何を選択したか
- なぜ選択したか（purpose / useCase）

例：
.delegate(.memberSelected(purpose: .payer, ids, names))

---

### 6.2 Delegate は Domain を直接変更しない

- Delegate は通知のみを行う
- 実際の反映は Draft または Adapter で行う

---

## 7. 仕様が揺れることを前提とする

### 7.1 揺れてよいもの

- View 構成
- Action 名
- 画面遷移フロー
- 一時的な Destination 定義

### 7.2 揺れてはいけないもの

- Domain の意味論
- Draft の存在意義
- Root の責務
- レイヤー分離の原則

---

## 8. 原則を破る場合の扱い

本原則を破る場合は、以下を明示する。

- なぜ破るのか
- 一時的か恒久的か
- どの原則に反するか

---

## 9. 最後に

MichiMark の設計において最も重視するのは、

後から読む自分が理解できること

である。

本書は将来の自分、共同開発者、AI に対する設計意図の共有手段である。
